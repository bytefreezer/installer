{{- if .Values.receiver.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "bytefreezer.receiver.fullname" . }}
  labels:
    {{- include "bytefreezer.receiver.labels" . | nindent 4 }}
data:
  config.yaml: |
    app:
      name: "bytefreezer-receiver"
      version: {{ .Chart.AppVersion | quote }}

    server:
      api_port: {{ .Values.receiver.service.apiPort }}

    bytefreezer:
      upload_worker_count: {{ .Values.receiver.uploadWorkerCount | default 5 }}
      spool_path: {{ .Values.receiver.spooling.directory | quote }}

    protocols:
      webhook:
        enabled: true
        port: {{ .Values.receiver.service.webhookPort }}
        max_payload_size: {{ .Values.receiver.maxPayloadSize | default 10485760 }}

    s3destination:
      bucket_name: {{ .Values.s3.buckets.intake | quote }}
      region: {{ .Values.s3.region | quote }}
      endpoint: {{ include "bytefreezer.s3Endpoint" . | quote }}
      ssl: {{ .Values.s3.useSSL }}
      use_iam_role: {{ .Values.s3.useIAMRole }}
      {{- if not .Values.s3.useIAMRole }}
      access_key: {{ .Values.s3.accessKey | quote }}
      secret_key: {{ .Values.s3.secretKey | quote }}
      {{- end }}

    housekeeping:
      enabled: true
      intervalseconds: 60

    dlq:
      enabled: {{ if .Values.receiver.dlq }}{{ .Values.receiver.dlq.enabled | default true }}{{ else }}true{{ end }}
      directory: {{ .Values.receiver.spooling.directory | quote }}
      retry_attempts: {{ if .Values.receiver.dlq }}{{ .Values.receiver.dlq.retryAttempts | default 3 }}{{ else }}3{{ end }}
      retry_interval_seconds: {{ if .Values.receiver.dlq }}{{ .Values.receiver.dlq.retryIntervalSeconds | default 60 }}{{ else }}60{{ end }}
      cleanup_interval_seconds: {{ if .Values.receiver.dlq }}{{ .Values.receiver.dlq.cleanupIntervalSeconds | default 300 }}{{ else }}300{{ end }}
      max_age_days: {{ if .Values.receiver.dlq }}{{ .Values.receiver.dlq.maxAgeDays | default 7 }}{{ else }}7{{ end }}

    control_service:
      enabled: {{ .Values.controlService.enabled }}
      control_url: {{ .Values.controlService.url | quote }}
      timeout_seconds: {{ .Values.controlService.timeoutSeconds }}
      api_key: {{ .Values.controlService.apiKey | quote }}

    spooling:
      enabled: {{ .Values.receiver.spooling.enabled }}
      directory: {{ .Values.receiver.spooling.directory | quote }}
      max_size_bytes: {{ .Values.receiver.spooling.maxSizeBytes }}
      retry_attempts: {{ .Values.receiver.spooling.retryAttempts }}
      retry_interval_seconds: {{ .Values.receiver.spooling.retryIntervalSeconds }}

    otel:
      enabled: {{ .Values.monitoring.enabled }}
      mode: {{ include "bytefreezer.metricsMode" . | quote }}
      {{- if include "bytefreezer.metricsEndpoint" . }}
      otlp_endpoint: {{ include "bytefreezer.metricsEndpoint" . | quote }}
      {{- end }}
      push_interval_seconds: {{ .Values.monitoring.pushIntervalSeconds }}
      service_name: "bytefreezer-receiver"
      metrics_host: "0.0.0.0"
      metrics_port: 9091

    health_reporting:
      enabled: {{ .Values.receiver.healthReporting.enabled }}
      report_interval: {{ .Values.receiver.healthReporting.reportInterval }}
      timeout_seconds: 10
      register_on_startup: true

    error_tracking:
      enabled: true
{{- end }}
